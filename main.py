import asyncio
import random
import csv
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters
)

# ==============================
# 🔹 تنظیمات اصلی
# ==============================
TOKEN = os.environ.get("TELEGRAM_TOKEN", "8319360335:AAEHRBtRqhDdS-rHr1x9X5A1-AnfgJJTlko")  # توکن ربات
ADMIN_ID = 677533280  # آیدی عددی ادمین (مثلاً 677533280)
RESULTS_FILE = "results.csv"
EXAM_DURATION = 15 * 60  # ۱۵ دقیقه

# ==============================
# 🔹 داده‌ها (سوالات)
# ==============================
QUESTIONS = [
    {
        "q": "در سگ‌های مبتلا به بیماری‌های مزمن روده، یافته کلیدی سونوگرافی با کنتراست (CEUS) که به افتراق لنفوم (Lymphoma) از بیماری التهابی روده (IBD) کمک می‌کند، کدام است؟",
        "options": [
            "الگوی هایپووسکولار (Hypovascular) منظم در لنفوم",
            "الگوی هایپرووسکولار (Hypervascular) نامنظم و افزایش سریع خون‌رسانی در لنفوم",
            "افزایش جریان خون پراکنده (Diffuse) و شدید در IBD",
            "کاهش ضخامت دیواره روده در لنفوم، بر خلاف IBD"
        ],
        "answer": 1  # ب
    },
    {
        "q": "مهم‌ترین محدودیت سونوگرافی B-mode در ارزیابی دستگاه گوارش سگ‌ها چیست؟",
        "options": [
            "عدم توانایی در تعیین ضخامت دیواره روده",
            "ناتوانی در ارائه اطلاعات در مورد مورفولوژی (Morphology) اندام",
            "محدودیت در ارزیابی جزئیات عملکردی بافت‌ها، به‌ویژه الگوی جریان خون",
            "ایجاد آرتیفکت‌های صوتی شدید توسط مو و پوست"
        ],
        "answer": 2  # ج
    },
    {
        "q": "اصلی‌ترین شاخص عملکردی که سونوگرافی با کنتراست (CEUS) با استفاده از میکروحباب‌ها (Microbubbles) در بافت روده ارزیابی می‌کند، کدام است؟",
        "options": [
            "ضخامت لایه‌های دیواره روده",
            "پرفیوژن (Perfusion) یا الگوی خون‌رسانی بافت‌ها",
            "قابلیت ارتجاعی (Stiffness) دیواره روده (الاستوگرافی)",
            "حرکات دودی (Peristalsis) روده"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در مقاله‌ای که به ارزیابی B-mode و CEUS برای روده سگ‌ها می‌پردازد، کدام شرایط بالینی به‌عنوان محدودیت استفاده از CEUS در سگ‌ها ذکر شده است؟",
        "options": [
            "ابتلا به سندرم روده تحریک‌پذیر (IBS)",
            "بیماری‌های کبدی مزمن",
            "نارسایی قلبی یا اختلالات تنفسی شدید",
            "نژادهای سگ با جثه بزرگ"
        ],
        "answer": 2  # ج
    },
    {
        "q": "ترکیب سونوگرافی B-mode و CEUS، به ترتیب، کدام جنبه‌های حیاتی دستگاه گوارش را مورد ارزیابی قرار می‌دهد؟",
        "options": [
            "لایه‌بندی دیواره روده و حرکت دودی روده",
            "مورفولوژی ساختاری و میزان جذب",
            "ساختار (ضخامت و لایه‌بندی دیواره) و عملکردی (جریان خون بافت‌ها)",
            "پرفیوژن و مورفولوژی غدد لنفاوی"
        ],
        "answer": 2  # ج
    },
    {
        "q": "کدام‌یک از موارد زیر، طبق مقاله مروری، از شکاف‌های تحقیقاتی مهم در زمینه سونوگرافی GI سگ‌ها محسوب می‌شود؟",
        "options": [
            "عدم وجود دستگاه‌های سونوگرافی با رزولوشن بالا",
            "فقدان دستورالعمل استانداردسازی پارامترهای سونوگرافی برای ضخامت دیواره روده در نژادهای مختلف",
            "بالا بودن هزینه انجام CEUS",
            "عدم آگاهی دامپزشکان عمومی از مزایای CEUS"
        ],
        "answer": 1  # ب
    },
    {
        "q": "یافته سونوگرافی B-mode در هر دو بیماری التهابی روده (IBD) و لنفوم روده کدام ناهنجاری را به اشتراک می‌گذارد که منجر به ابهام تشخیصی می‌شود؟",
        "options": [
            "وجود اجسام خارجی",
            "افزایش ضخامت دیواره روده و از بین رفتن لایه‌بندی آن",
            "تجمع مایع آزاد در حفره شکم",
            "وجود یک توده با اکوژنیسیته مختلط"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در لنفوم، الگوی جریان خون (Perfusion) در CEUS چگونه توصیف می‌شود؟",
        "options": [
            "هیپووسکولار",
            "هایپووسکولار موضعی",
            "هایپرووسکولار نامنظم و افزایش سریع خون‌رسانی",
            "نرمال یا کمی کاهش یافته"
        ],
        "answer": 2  # ج
    },
    {
        "q": "«وضعیت دعا» (Praying Position) در سگ‌ها، که گاهی در پانکراتیت حاد (AP) مشاهده می‌شود، نشان‌دهنده کدام علامت بالینی است؟",
        "options": [
            "زردی",
            "درد شدید شکم",
            "کم‌آبی شدید",
            "ضعف و بی‌اشتهایی"
        ],
        "answer": 1  # ب
    },
    {
        "q": "معیار مرجع سنتی (Gold Standard) برای تشخیص قطعی پانکراتیت حاد (AP) و تمایز آن از پانکراتیت مزمن (CP) کدام است، که البته در عمل بالینی مورد تردید قرار گرفته است؟",
        "options": [
            "سونوگرافی شکم (AUS)",
            "آزمایش Spec cPL",
            "بافت‌شناسی (هیستوپاتولوژی)",
            "شمارش کامل خون (CBC)"
        ],
        "answer": 2  # ج
    },
    {
        "q": "آزمایش فعالیت آمیلاز سرم به دلیل کدام ویژگی، دیگر بخشی از رویکرد تشخیصی روتین برای پانکراتیت حاد (AP) در سگ‌ها محسوب نمی‌شود؟",
        "options": [
            "حساسیت بسیار پایین",
            "اختصاصیت پایین به دلیل منشأ بافتی متعدد آمیلاز",
            "هزینه‌بر بودن",
            "تأثیرپذیری شدید از بیلی‌روبین و لیپید"
        ],
        "answer": 1  # ب
    },
    {
        "q": "غلظت Spec cPL در سرم سگ که به شدت نشان‌دهنده پانکراتیت حاد (AP) است، چقدر گزارش شده است؟",
        "options": [
            "۱۰۰ μg/L",
            "۲۰۰ μg/L",
            "۴۰۰ μg/L",
            "۸۰۰ μg/L"
        ],
        "answer": 2  # ج
    },
    {
        "q": "سونوگرافی شکم (AUS) در تشخیص پانکراتیت حاد (AP)، یافته‌هایی شامل بزرگ شدن پانکراس، کاهش اکوژنیسیته پارانشیم و افزایش اکوژنیسیته کدام بافت اطراف پانکراس را نشان می‌دهد؟",
        "options": [
            "عروق اطراف",
            "چربی‌های اطراف",
            "غدد لنفاوی ناحیه‌ای",
            "دیواره دوازدهه (Duodenum)"
        ],
        "answer": 1  # ب
    },
    {
        "q": "آزمایش Spec cPL با استفاده از چند آنتی‌بادی مونوکلونال اختصاصی برای لیپاز پانکراس سگ طراحی شده است؟",
        "options": [
            "یک آنتی‌بادی",
            "دو آنتی‌بادی",
            "سه آنتی‌بادی",
            "چهار آنتی‌بادی"
        ],
        "answer": 1  # ب
    },
    {
        "q": "کدام روش تصویربرداری پیشرفته در تشخیص پانکراتیت حاد (AP)، برتری نسبت به سونوگرافی در شناسایی ویژگی‌هایی مانند ترومبوز ورید پورتال را دارد؟",
        "options": [
            "سونوگرافی با کنتراست (CEUS)",
            "آنژیوگرافی توموگرافی کامپیوتری (CTA)",
            "تصویربرداری رزونانس مغناطیسی (MRI)",
            "الاستوگرافی (Elastography)"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در مقایسه بین مطالعات مبتنی بر معیار بالینی و مطالعات مبتنی بر معیار بافت‌شناسی (هیستوپاتولوژی)، حساسیت Spec cPL برای موارد متوسط تا شدید AP چگونه است؟",
        "options": [
            "حساسیت Spec cPL در مطالعات بالینی پایین‌تر است (۷۱٪)",
            "حساسیت Spec cPL در مطالعات بالینی بالاتر است (۸۱ تا ۹۰.۹٪)",
            "حساسیت در هر دو نوع مطالعه یکسان است (حدود ۸۰٪)",
            "Spec cPL فقط در مطالعات بافت‌شناسی معتبر است"
        ],
        "answer": 1  # ب
    },
    {
        "q": "موکوپلی‌ساکاریدوز (MPS) در سگ‌ها در کدام دسته از بیماری‌های ارثی متابولیک طبقه‌بندی می‌شود؟",
        "options": [
            "بیماری‌های نقص ایمنی اولیه",
            "اختلالات ذخیره لیزوزومی (Lysosomal Storage Disorders - LSDs)",
            "آنسفالوپاتی‌های ارثی میتوکندریایی",
            "بیماری‌های ذخیره گلیکوژن"
        ],
        "answer": 1  # ب
    },
    {
        "q": "عامل پاتوفیزیولوژیک اولیه در بیماری MPS که منجر به اختلال عملکرد سلولی و بافتی می‌شود، کدام است؟",
        "options": [
            "نقص در سنتز پروتئین‌های غشایی",
            "تجمع پیش‌رونده گلیکوزآمینوگلیکان‌های (GAGs) تجزیه‌نشده در لیزوزوم‌ها",
            "افزایش فعالیت آنزیم‌های لیزوزومی",
            "کمبود انرژی سلولی به دلیل اختلالات میتوکندریایی"
        ],
        "answer": 1  # ب
    },
    {
        "q": "گلیکوزآمینوگلیکان‌ها (GAGs)، که تجمع آن‌ها عامل بیماری MPS است، قبلاً با چه نامی شناخته می‌شدند؟",
        "options": [
            "لیپوپروتئین‌ها",
            "موکوپلی‌ساکاریدها",
            "اسفنگولیپیدها",
            "گلیکوپروتئین‌ها"
        ],
        "answer": 1  # ب
    },
    {
        "q": "کدام رویکرد درمانی برای MPS I و MPS VII در مدل‌های سگ، نشان داده است که بهبودهای قابل توجه در علائم سوماتیک و عصبی ایجاد کرده است؟",
        "options": [
            "درمان جایگزینی آنزیم (ERT)",
            "درمان با مولکول‌های کوچک",
            "آنتی‌سنس اولیگونوکلئوتید (ASO)",
            "پیوند مغز استخوان (BMT)"
        ],
        "answer": 0  # الف
    },
    {
        "q": "اصلی‌ترین خطر عمده‌ای که با پیوند مغز استخوان (BMT) برای درمان MPS در مطالعات گزارش شده است، کدام است؟",
        "options": [
            "عدم پیوند سلول‌های اهداکننده",
            "بیماری پیوند علیه میزبان و مرگ‌ومیر مرتبط با درمان",
            "پس زدن کامل سلول‌ها توسط سیستم عصبی مرکزی",
            "مسمومیت کلیوی طولانی‌مدت"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در روش ژن‌درمانی (Gene Therapy) برای MPS، کدام نوع از وکتورهای ویروسی برای انتقال نسخه عملکردی ژن معیوب به سلول‌های بیمار، نتایج چشمگیری در مدل‌های سگ (مانند MPS I و IIIB) نشان داده است؟",
        "options": [
            "ویروس آدنوویروس (Adenovirus)",
            "وکتورهای ویروسی مرتبط با آدنو (AAV)",
            "وکتورهای ویروسی لنتی (Lentiviral Vectors)",
            "ویروس هرپس"
        ],
        "answer": 1  # ب
    },
    {
        "q": "نقش مدل‌های سگ مبتلا به MPS در تحقیقات دامپزشکی و انسانی چگونه توصیف شده است؟",
        "options": [
            "صرفاً برای مطالعه تاریخ طبیعی بیماری",
            "فرصتی بی‌نظیر برای مطالعه تاریخ طبیعی بیماری و آزمایش ایمنی و اثربخشی درمان‌های نوین",
            "تنها به‌عنوان ابزاری برای تأیید نتایج انسانی",
            "نقش محدود به دلیل تفاوت‌های ژنتیکی عمده با انسان"
        ],
        "answer": 1  # ب
    },
    {
        "q": "مسیرهای تزریق وکتورهای ژن‌درمانی (مانند AAV) که نتایج برجسته‌ای در مدل‌های سگ مبتلا به MPS I و IIIB داشته است، کدامند؟",
        "options": [
            "فقط تزریق عضلانی و زیرپوستی",
            "تزریق داخل نخاعی، داخل بطنی-مغزی و وریدی",
            "فقط تزریق داخل مفصلی",
            "تزریق داخل چشمی و داخل صفاقی"
        ],
        "answer": 1  # ب
    },
    {
        "q": "مهم‌ترین مزیت آندوسکوپی کپسولی نسبت به آندوسکوپی کلاسیک از منظر ایمنی بیمار چیست؟",
        "options": [
            "امکان خروج اجسام خارجی",
            "حذف کامل نیاز به آرام‌بخشی یا بیهوشی عمومی",
            "امکان مشاهده کل دستگاه گوارش",
            "زمان کوتاه‌تر مشاهده"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در مقایسه آندوسکوپی کپسولی و کلاسیک، برتری اصلی آندوسکوپی کپسولی در کجاست؟",
        "options": [
            "قابلیت نمونه‌برداری دقیق‌تر",
            "تجسم و ارزیابی جامع روده کوچک",
            "قابلیت توقف خونریزی",
            "سرعت بیشتر در انجام معاینه"
        ],
        "answer": 1  # ب
    },
    {
        "q": "بزرگ‌ترین محدودیت آندوسکوپی کپسولی در مقایسه با آندوسکوپی کلاسیک، کدام قابلیت حیاتی را از دامپزشک سلب می‌کند؟",
        "options": [
            "مشاهده هم‌زمان بافت",
            "امکان مداخله درمانی فوری (مانند خارج کردن جسم خارجی یا بیوپسی)",
            "قابلیت ضبط تصاویر",
            "امکان استفاده در سگ‌های کوچک"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در سگ‌های با علت نامشخص خونریزی گوارشی، آندوسکوپی کپسولی به‌طور خاص به‌عنوان ابزاری مفید در کدام مورد استفاده می‌شود؟",
        "options": [
            "ارزیابی کولون",
            "تشخیص خونریزی گوارشی که با روش‌های مرسوم قابل تشخیص نیست",
            "خارج کردن سنگ‌ها",
            "اندازه‌گیری pH معده"
        ],
        "answer": 1  # ب
    },
    {
        "q": "یکی از معایب کلیدی آندوسکوپی کلاسیک که در آندوسکوپی کپسولی رفع می‌شود، چیست؟",
        "options": [
            "عدم توانایی در رسیدن به اثنی‌عشر",
            "نیاز به آرام‌بخشی یا بیهوشی که باعث افزایش خطر عوارض و استرس بیمار می‌شود",
            "کیفیت تصویر پایین",
            "وابستگی زیاد به مهارت اپراتور"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در مورد سگ‌های با جثه کوچک، آندوسکوپی کپسولی چه مزیتی نسبت به آندوسکوپ‌های کلاسیک دارد؟",
        "options": [
            "ارزان‌تر است",
            "آندوسکوپ‌های کلاسیک معمولاً بزرگ‌تر هستند و برای سگ‌های خیلی کوچک مناسب نیستند، که این مزیت آندوسکوپی کپسولی است",
            "نیاز به تکرار کمتری دارد",
            "قابلیت استفاده در سگ‌های زیر ۲ کیلوگرم را ندارد"
        ],
        "answer": 1  # ب
    },
    {
        "q": "کدام‌یک از اقدامات درمانی یا تشخیصی زیر، فقط با آندوسکوپی کلاسیک امکان‌پذیر است و با آندوسکوپی کپسولی خیر؟",
        "options": [
            "تشخیص التهاب روده",
            "ارزیابی پیشرفت تومور",
            "خارج کردن اجسام خارجی یا گسترش تنگی‌ها",
            "نظارت بر بیماری التهابی روده (IBD)"
        ],
        "answer": 2  # ج
    },
    {
        "q": "آندوسکوپی کپسولی یک نمای دقیق از کدام ساختار را ارائه می‌دهد که به تشخیص و نظارت بر بیماری التهابی روده (IBD) کمک می‌کند؟",
        "options": [
            "بافت همبند اطراف روده",
            "پوشش صفاقی",
            "مخاط روده",
            "غدد لنفاوی مزانتریک"
        ],
        "answer": 2  # ج
    },
    {
        "q": "در مطالعه‌ای که هوش مصنوعی (CNN) را برای تشخیص بزرگ‌شدگی دهلیز چپ سگ با رادیولوژیست دامپزشکی مقایسه کرد، دقت کلی الگوریتم هوش مصنوعی چگونه بود؟",
        "options": [
            "به‌طور قابل‌توجهی بالاتر از رادیولوژیست بود",
            "به‌طور قابل‌توجهی پایین‌تر از رادیولوژیست بود",
            "یکسان با دقت رادیولوژیست دامپزشکی بود",
            "بستگی به نژاد سگ داشت"
        ],
        "answer": 2  # ج
    },
    {
        "q": "هوش مصنوعی در رادیولوژی تشخیصی، به‌ویژه در کدام شرایط، می‌تواند مزیت قابل توجهی در تفسیر تصویر ارائه دهد؟",
        "options": [
            "در شرایطی که تصاویر کاملاً نرمال هستند",
            "زمانی که رادیولوژیست متخصص در دسترس نیست (شرایط اضطراری)",
            "برای موارد بسیار پیچیده و نادر",
            "برای گزارش‌های رادیوگرافی ستون فقرات"
        ],
        "answer": 1  # ب
    },
    {
        "q": "کدام روش تصویربرداری، طبق گزارش‌ها، کارآمدترین روش برای تشخیص و اندازه‌گیری ذهنی پلورال افیوژن (PE) است؟",
        "options": [
            "سونوگرافی قفسه سینه",
            "رادیوگرافی قفسه سینه",
            "توموگرافی کامپیوتری (CT)",
            "MRI"
        ],
        "answer": 1  # ب
    },
    {
        "q": "هدف اصلی الگوریتم هوش مصنوعی Vetology AI Guardian® در رادیوگرافی‌های قفسه سینه سگ‌ها چه بود؟",
        "options": [
            "پیش‌بینی طول عمر سگ",
            "ارزیابی عملکرد قلبی",
            "شناسایی انواع ویژگی‌های ارزیابی‌شده معمول (مانند پلورال افیوژن، کاردیومگالی و...)",
            "اندازه‌گیری فشارخون ریوی"
        ],
        "answer": 2  # ج
    },
    {
        "q": "مهم‌ترین معیار افتراقی که برای تمایز سندرم دفع نمکی مغزی (CSW) از سندرم ترشح نامتناسب هورمون ضدادراری (SIADH) استفاده می‌شود، کدام است؟",
        "options": [
            "میزان سدیم سرم",
            "وضعیت حجم خارج سلولی (در CSW حجم کاهش و در SIADH حجم طبیعی یا افزایش می‌یابد)",
            "وجود آسیب تروماتیک مغزی (TBI)",
            "میزان اسمولالیته ادرار"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در شرح حال اولیه کیس گزارش شده از سندرم CSW در توله سگ پوینتر (صفحه ۳۹)، کدام یافته‌های آزمایشگاهی طبیعی گزارش شدند؟",
        "options": [
            "سطح گلوکز و BUN",
            "سدیم سرم و نتایج CBC",
            "سطح کراتینین و پتاسیم",
            "سطح پروتئین کل و آلبومین"
        ],
        "answer": 1  # ب
    },
    {
        "q": "در پاتوفیزیولوژی کم‌خونی ناشی از فقر آهن، دلیل اصلی ایجاد میکروسیتوز (کوچک شدن گلبول‌های قرمز) چیست؟",
        "options": [
            "تقسیم سلولی سریع‌تر از حد نرمال",
            "عدم تولید کافی هموگلوبین به دلیل کمبود آهن، که باعث می‌شود تقسیم سلولی بیشتری رخ دهد",
            "کاهش زمان عمر گلبول‌های قرمز",
            "تخریب سریع گلبول‌های قرمز در طحال"
        ],
        "answer": 1  # ب
    },
    {
        "q": "سوال اصلی که مرور نظام‌مند کریستنسن و همکاران (۲۰۱۵) در مورد غلظت سرمی CRP در سگ‌ها مورد بررسی قرار داد، کدام بود؟",
        "options": [
            "آیا CRP می‌تواند ترومای جراحی را پیش‌بینی کند؟",
            "آیا CRP می‌تواند عفونت‌های ثانویه را پیش‌بینی کند؟",
            "آیا غلظت سرمی CRP در سگ‌های مبتلا به عوارض عفونی پس از عمل، در مقایسه با سگ‌های فاقد چنین عوارضی، به‌طور قابل‌توجهی متفاوت است؟",
            "آیا CRP می‌تواند نوع جراحی را تعیین کند؟"
        ],
        "answer": 2  # ج
    }
]

user_data = {}

# ==============================
# 🔹 ایجاد فایل نتایج
# ==============================
if not os.path.exists(RESULTS_FILE):
    with open(RESULTS_FILE, "w", newline='', encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["Name", "Student ID", "User ID", "Score", "Percent"])

# ==============================
# 🔹 دستور /start
# ==============================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in user_data and user_data[user_id].get("completed"):
        await update.message.reply_text("⚠️ شما قبلاً در این آزمون شرکت کرده‌اید.")
        return
    user_data[user_id] = {"stage": "name"}
    await update.message.reply_text("👋 لطفاً نام و نام خانوادگی خود را وارد کنید:")

# ==============================
# 🔹 دریافت نام و شماره دانشجویی
# ==============================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text.strip()

    if user_id not in user_data:
        await update.message.reply_text("برای شروع آزمون دستور /start را بزنید.")
        return

    stage = user_data[user_id].get("stage")

    if stage == "name":
        user_data[user_id]["name"] = text
        user_data[user_id]["stage"] = "student_id"
        await update.message.reply_text("📘 شماره دانشجویی خود را وارد کنید:")
    elif stage == "student_id":
        user_data[user_id]["student_id"] = text
        user_data[user_id]["stage"] = "ready"
        await show_rules(update, context)

# ==============================
# 🔹 مقررات آزمون
# ==============================
async def show_rules(update: Update, context: ContextTypes.DEFAULT_TYPE):
    rules = (
        "📜 **مقررات آزمون:**\n\n"
        "1️⃣ آزمون دارای *نمره منفی* است.\n"
        "2️⃣ مدت زمان پاسخ‌گویی *۱۵ دقیقه* است.\n"
        "3️⃣ با زدن دکمه زیر آزمون آغاز می‌شود.\n\n"
        "آیا آماده‌اید؟ 🚀"
    )
    button = InlineKeyboardMarkup([[InlineKeyboardButton("✅ شروع آزمون", callback_data="start_exam")]])
    await update.message.reply_text(rules, parse_mode="Markdown", reply_markup=button)

# ==============================
# 🔹 مدیریت دکمه‌ها
# ==============================
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    data = user_data.get(user_id, {})
    await query.answer()

    if query.data == "start_exam":
        await query.edit_message_text("🟢 آزمون آغاز شد! موفق باشید 🌟")
        await asyncio.sleep(0.5)
        await start_exam(context, user_id)
        return

    if "questions" not in data or data.get("completed"):
        return

    q = data["questions"][data["index"]]
    answer = query.data

    if answer == "skip":
        pass
    elif answer == "end_exam":
        await query.edit_message_text("📤 آزمون پایان یافت.")
        await finish_exam(context, user_id)
        return
    else:
        answer = int(answer)
        if answer == q["answer"]:
            data["score"] += 1
        else:
            data["score"] -= 0.5

    data["index"] += 1

    if data["index"] >= len(data["questions"]):
        await finish_exam(context, user_id)
    else:
        await send_next_question(context, user_id)

# ==============================
# 🔹 شروع آزمون
# ==============================
async def start_exam(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    data = user_data[user_id]
    data["questions"] = random.sample(QUESTIONS, len(QUESTIONS))
    data["index"] = 0
    data["score"] = 0
    data["completed"] = False
    asyncio.create_task(exam_timer(context, user_id))
    await send_next_question(context, user_id)

# ==============================
# 🔹 تایمر آزمون
# ==============================
async def exam_timer(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    await asyncio.sleep(EXAM_DURATION)
    data = user_data.get(user_id)
    if data and not data.get("completed"):
        await context.bot.send_message(chat_id=user_id, text="⏰ زمان آزمون به پایان رسید!")
        await finish_exam(context, user_id)

# ==============================
# 🔹 ارسال سوال بعدی
# ==============================
async def send_next_question(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    data = user_data[user_id]
    q = data["questions"][data["index"]]
    buttons = [[InlineKeyboardButton(opt, callback_data=str(i))] for i, opt in enumerate(q["options"])]
    if data["index"] == len(data["questions"]) - 1:
        buttons.append([InlineKeyboardButton("📤 پایان آزمون", callback_data="end_exam")])
    else:
        buttons.append([InlineKeyboardButton("⏭ رد کردن", callback_data="skip")])
    await context.bot.send_message(
        chat_id=user_id,
        text=f"❓ سؤال {data['index'] + 1} از {len(data['questions'])}\n\n{q['q']}",
        reply_markup=InlineKeyboardMarkup(buttons)
    )

# ==============================
# 🔹 پایان آزمون و ارسال نتایج
# ==============================
async def finish_exam(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    data = user_data[user_id]
    if data.get("completed"):
        return
    data["completed"] = True

    total = len(data["questions"])
    percent = max((data["score"] / total) * 100, 0)
    name = data["name"]
    student_id = data["student_id"]

    # ذخیره در فایل CSV
    with open(RESULTS_FILE, "a", newline='', encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow([name, student_id, user_id, data["score"], f"{percent:.1f}%"])

    # پیام برای کاربر
    await context.bot.send_message(
        chat_id=user_id,
        text=f"✅ آزمون پایان یافت!\n📊 نمره: {data['score']} از {total}\nدرصد: {percent:.1f}%"
    )

    # ارسال نتیجه به ادمین
    msg = (
        f"📋 نتیجه آزمون جدید:\n\n"
        f"👤 نام: {name}\n"
        f"🎓 شماره دانشجویی: {student_id}\n"
        f"🆔 کاربر: {user_id}\n"
        f"📊 نمره: {data['score']} از {total}\n"
        f"درصد: {percent:.1f}%"
    )
    try:
        await context.bot.send_message(chat_id=ADMIN_ID, text=msg)
    except Exception as e:
        print(f"خطا در ارسال نتیجه به ادمین: {e}")

# ==============================
# 🔹 اجرای ربات
# ==============================
async def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_handler(CallbackQueryHandler(button_handler))

    print("🚀 ربات در حال اجرا است...")
    # شروع polling
    await app.initialize()
    await app.start()
    await app.updater.start_polling(drop_pending_updates=True)
    # نگه داشتن برنامه در حال اجرا
    while True:
        await asyncio.sleep(3600)  # خواب برای جلوگیری از اتمام حلقه

if __name__ == "__main__":
    # ایجاد حلقه رویداد جدید
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    try:
        loop.run_until_complete(main())
    except KeyboardInterrupt:
        loop.run_until_complete(app.updater.stop())
        loop.run_until_complete(app.stop())
        loop.run_until_complete(app.shutdown())
    finally:
        loop.close()
